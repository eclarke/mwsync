{"name":"Mwsync","body":"mwsync-lib\r\n==========\r\n\r\nAbout\r\n----------\r\n__mwsync__ is a framework for creating a live, one-way 'mirror' of one MediaWiki onto another. It can be used for anything from maintaining a live mirror of the entire English Wikipedia to integrating multiple MediaWiki sites into one.\r\nIt was created as part of the [GeneWiki+](http://genewikiplus.org) project, which takes the 10,400+ human gene pages on [Wikipedia](http://en.wikipedia.org) and integrates them with a [mutation database](http://snpedia.com) and an ontology of human diseases. We've extracted the core of that project for general use.\r\n\r\nDependencies\r\n------------\r\nThere are no dependencies! \r\n    \r\nInstallation\r\n------------\r\nAs a library, you will use __mwsync__ to build your own custom Sync programs. We recommend using it as a Maven dependency, but it's not necessary. Use of a Java IDE such as [Eclipse](http://eclipse.org) with a Maven plugin can simplify things greatly.\r\n\r\nTo install __mwsync__ as a Maven module, follow the same instructions as above:\r\n\r\n```bash\r\nhg clone https://bitbucket.org/sulab/mwsync\r\ncd mwsync\r\nmvn install\r\n```\r\n    \r\nFrom Eclipse, you might alternatively import it as a Maven project, right-click the project folder, and choose \"Run as -> Maven Install\".\r\n\r\nAlternatively, you may choose to export it as a .jar file if you do not wish to use Maven in your own projects. From Eclipse, choose Export -> Jar File and follow the instructions provided.\r\n\r\nFinally, in your own projects, import the final product into your classpath.\r\n__As a maven module:__\r\nFind and add `edu.scripps.mwsync` as a Maven dependency\r\n__As a standalone .jar file__:\r\nIn Eclipse, add mwsync.jar (or whatever you named it during export) to the Java Build Path (Project -> Properties... Java Build Path)\r\n\r\nUsage\r\n------\r\n__To create a bare-bones, one-way mirror of a selection of pages on Wikipedia:__\r\n\r\n1. Create an account on Wikipedia and add the selection of pages to your watchlist. One way to add a large number of pages at once is to generate a list of titles (one per line) and add them to the [raw watchlist editor](http://en.wikipedia.org/wiki/Special:EditWatchlist/raw). You can also do this programmatically using the API.\r\n\r\n2. With your account information for both Wikipedia and the target MediaWiki site you wish to use as a mirror, edit `mwsync.example.conf`, filling in the information for each field. Save this file as `mwsync.conf` somewhere on the filesystem. That location will be where temporary and log files are written, so ensure the permissions are correct.\r\n\r\n3. Create a new Java project (if using Eclipse) and ensure __mwsync-lib__ is in your classpath and importable by your code. The code below builds a basic sync app:\r\n\r\nBasic Sync App:\r\n\r\n```java\r\nimport edu.scripps.mwsync.*\r\n\r\npublic class MySyncApp\r\n{\r\n    public static void main(String[] args) throws Exception\r\n    {\r\n        Sync sync = Sync.newFromConfigFile(\"/etc/mysyncapp/sync.conf\");\r\n        sync.run();\r\n    }\r\n}\r\n```\r\n\t\r\nAdd the following directive to your `crontab` file (on *nix systems) to run every 5 minutes:\r\n\r\n    */5 * *   *   *   root  java -jar <PATH_TO_SYNC_JAR>/sync.jar\r\n\r\nFor Windows, use Scheduled Tasks or the `at` command.\r\n\r\n__To create a mirror that _alters content_ before posting to target:__\r\n\r\n1. Follow the directions as above to set up your accounts.\r\n\r\n2. Create a class that implements the Rewriter interface (see example below)\r\n\r\n3. Attach your custom Rewriter object to the Sync object, then run.\r\n\r\nSync App with Custom Rewriter:\r\n\r\n```java\r\nimport edu.scripps.mwsync.*\r\nimport edu.scripps.genewiki.common.Wiki;\r\n\r\npublic class MySyncApp\r\n{\r\n    static class CustomRewriter implements Rewriter\r\n    {\r\n        /*\r\n         * Replace all instances of 'cats' with 'dogs'\r\n         */\r\n        public String process(String text, String title, Wiki source,\r\n            Wiki target)\r\n        {\r\n            return text.replaceAll(\"cats\", \"dogs\");\r\n        }\r\n    }\r\n    \r\n    public static void main(String[] args) \r\n    {\r\n        try {\r\n            Sync sync = Sync.newFromConfigFile(\"/etc/mysyncapp/sync.conf\");\r\n            CustomRewriter rewriter = new CustomRewriter();\r\n            sync.addRewriter(rewriter);\r\n            sync.run();\r\n        // of course, your error handling will be more specific...\r\n        catch (Exception e) {  \r\n            system.out.println(\"Problem running sync!\");\r\n            system.exit(1)\r\n    }\r\n}\r\n```\r\n\t\r\nRunning on a schedule:\r\n---------------------\r\nThe Sync library itself does not handle repeated runs, so in order to maintain up-to-date data, you have to schedule it with your OS's task scheduler. The easiest is simply to use Unix `cron`, but alternatives exist.\r\nThe sync checks for the last time it was run. If it can't find a previous time, it skips back a day and pulls all changes since that time. To force this reset, delete _lastChecked.cal.ser_ in the mwsync folder.\r\n\r\nCommon Rewrite Rules\r\n----------\r\nBelow are some generic rewrite rules you may want to use if porting a MediaWiki site to a Semantic MediaWiki mirror:\r\n\r\nAppending a 'Mirrored' banner to each page:\r\n    \r\n```java\r\npublic static String prependMirroredTemplate(String src){\r\n    if (src.startsWith(\"{{Mirrored\")) {\r\n        return src;\r\n    } else {\r\n        return \"{{Mirrored | {{PAGENAME}} }} \\n\" + src;\r\n    }\r\n}\r\n```\r\n\t\r\nAdding a semantic property to all links, except already-typed semantic links, category links, and namespaces, or, if a link does not exist on the source Wiki, making the link point back to Wikipedia:\r\n\r\n```java\r\npublic static String fixLinks(String src, Wiki target) {\r\n    \r\n    // add a marker to all the links so we can iterate through them (except the ones that point to wikipedia)\r\n    String src2 = src.replaceAll(\"\\\\[\\\\[(?!(wikipedia))\", \"[[%\");\r\n    \r\n    try {\r\n        while (src2.contains(\"[[%\")) {\r\n            \r\n            // extract the link text\r\n            int a = src2.indexOf(\"[[%\")+3;  // left inner bound\r\n            int b = src2.indexOf(\"]]\", a);  // right inner bound\r\n            String link = src2.substring(a, b);\r\n            \r\n            // remove the label, if present\r\n            int pipe = link.indexOf('|');\r\n            link = (pipe == -1) ? link : src2.substring(a, a+pipe);\r\n\r\n            // If the link does not exist (and is not a semantic wikilink or category), append 'wikipedia:'\r\n            if (!link.contains(\"::\") && !link.contains(\":\") && !link.contains(\"Category:\") && !target.exists(link)[0]) {\r\n                src2 = src2.substring(0, a-1) + \"wikipedia:\" + src2.substring(a);\r\n            // else if it's not a special link (like File: or en:), make it a semantic link\r\n            } else if (!link.contains(\":\")) {\r\n                src2 = src2.substring(0, a-1) + \"is_associated_with::\" + src2.substring(a);\r\n            // otherwise just remove the marker and move on\r\n            } else {\r\n                src2 = src2.substring(0, a-1) + src2.substring(a);\r\n            }\r\n        }\r\n    } catch (IOException e) {\r\n        e.printStackTrace();\r\n        return src;\r\n    }\r\n    return src2;\r\n}\r\n```\r\n\r\nTo see the full suite of rewrite rules that we use for building genewiki+, visit [our gwsync repository](http://bitbucket.org/sulab/gwsync) and find the GeneWikiEditor class.\r\n\r\nBugs and Errata\r\n-----------------\r\nThe included MediaWiki Java API has been forked and customized to use the SMW Ask API extension. Note, however, that this is not identical to the Ask API incorporated into Semantic Mediawiki > 1.7. To adapt the Wiki class, update the \"ask\" functions to use '&query=' instead of '&q=' (and possibly other changes... we haven't upgraded to 1.7 yet so this is untested.)\r\n\r\nContact\r\n------------\r\nPlease feel free to email the developer for support or questions at eclarke \\at\\ scripps \\dot\\ edu.\r\n","tagline":"Java framework to create live mirrors of MediaWiki sites.","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}